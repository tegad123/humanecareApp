generator client {
  provider     = "prisma-client"
  output       = "../generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

// ─── Enums ──────────────────────────────────────────────

enum Role {
  super_admin
  admin
  recruiter
  compliance
  scheduler
  payroll
  clinician
}

enum Discipline {
  PT
  OT
  SLP
  MSW
  RN
  LPN
  HHA
  PTA
  COTA
  OTHER
}

enum ChecklistItemType {
  file_upload
  text
  date
  select
  e_signature
  admin_status
}

enum ChecklistItemStatus {
  not_started
  submitted
  pending_review
  approved
  rejected
  expired
}

enum ClinicianStatus {
  not_started
  onboarding
  ready
  not_ready
  inactive
}

enum PlanTier {
  starter
  growth
  pro
}

// ─── Organizations ──────────────────────────────────────

model Organization {
  id        String   @id @default(uuid())
  name      String
  planTier  PlanTier @default(starter) @map("plan_tier")
  planFlags Json     @default("{}") @map("plan_flags")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  users                   User[]
  clinicians              Clinician[]
  checklistTemplates      ChecklistTemplate[]
  clinicianChecklistItems ClinicianChecklistItem[]
  auditLogs               AuditLog[]
  internalNotes           InternalNote[]
  templateDocuments       TemplateDocument[]
  emailSettings           OrgEmailSettings?

  @@map("organizations")
}

// ─── Users ──────────────────────────────────────────────

model User {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  clerkUserId    String   @unique @map("clerk_user_id")
  email          String
  name           String?
  role           Role     @default(admin)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organization       Organization             @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  assignedClinicians Clinician[]              @relation("AssignedRecruiter")
  auditLogs          AuditLog[]
  internalNotes      InternalNote[]
  reviewedItems      ClinicianChecklistItem[] @relation("ReviewedBy")

  @@index([organizationId])
  @@index([clerkUserId])
  @@map("users")
}

// ─── Clinicians ─────────────────────────────────────────

model Clinician {
  id                     String          @id @default(uuid())
  organizationId         String          @map("organization_id")
  firstName              String          @map("first_name")
  lastName               String          @map("last_name")
  email                  String
  phone                  String?
  discipline             Discipline
  templateId             String?         @map("template_id")
  assignedRecruiterId    String?         @map("assigned_recruiter_id")
  status                 ClinicianStatus @default(not_started)
  adminOverrideActive    Boolean         @default(false) @map("admin_override_active")
  adminOverrideValue     ClinicianStatus? @map("admin_override_value")
  adminOverrideReason    String?         @map("admin_override_reason")
  adminOverrideExpiresAt DateTime?       @map("admin_override_expires_at")
  npi                    String?
  coverageArea           String?         @map("coverage_area")
  rateInternal           Decimal?        @map("rate_internal") @db.Decimal(10, 2)
  notes                  String?
  clerkUserId            String?         @unique @map("clerk_user_id")
  inviteToken            String?         @unique @map("invite_token")
  inviteExpiresAt        DateTime?       @map("invite_expires_at")
  createdAt              DateTime        @default(now()) @map("created_at")
  updatedAt              DateTime        @updatedAt @map("updated_at")

  organization      Organization             @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  template          ChecklistTemplate?       @relation(fields: [templateId], references: [id])
  assignedRecruiter User?                    @relation("AssignedRecruiter", fields: [assignedRecruiterId], references: [id])
  checklistItems    ClinicianChecklistItem[]
  auditLogs         AuditLog[]
  internalNotes     InternalNote[]

  @@index([organizationId])
  @@index([organizationId, status])
  @@index([email])
  @@map("clinicians")
}

// ─── Checklist Templates ────────────────────────────────

model ChecklistTemplate {
  id               String   @id @default(uuid())
  organizationId   String?  @map("organization_id")
  name             String
  slug             String   @unique
  state            String?
  discipline       Discipline?
  description      String?
  sourceTemplateId String?  @map("source_template_id")
  isCustomized     Boolean  @default(false) @map("is_customized")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  organization      Organization?           @relation(fields: [organizationId], references: [id])
  sourceTemplate    ChecklistTemplate?      @relation("TemplateClone", fields: [sourceTemplateId], references: [id])
  clonedTemplates   ChecklistTemplate[]     @relation("TemplateClone")
  itemDefinitions   ChecklistItemDefinition[]
  clinicians        Clinician[]
  templateDocuments TemplateDocument[]

  @@index([organizationId])
  @@map("checklist_templates")
}

// ─── Checklist Item Definitions ─────────────────────────

model ChecklistItemDefinition {
  id                String            @id @default(uuid())
  templateId        String            @map("template_id")
  label             String
  section           String
  type              ChecklistItemType
  required          Boolean           @default(true)
  blocking          Boolean           @default(false)
  adminOnly         Boolean           @default(false) @map("admin_only")
  hasExpiration     Boolean           @default(false) @map("has_expiration")
  expirationFieldId String?           @map("expiration_field_id")
  sortOrder         Int               @default(0) @map("sort_order")
  configJson        Json?             @map("config_json")
  instructions      String?
  highRisk          Boolean           @default(false) @map("high_risk")
  enabled           Boolean           @default(true)
  linkedDocumentId  String?           @map("linked_document_id")
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")

  template       ChecklistTemplate        @relation(fields: [templateId], references: [id], onDelete: Cascade)
  linkedDocument TemplateDocument?         @relation(fields: [linkedDocumentId], references: [id], onDelete: SetNull)
  clinicianItems ClinicianChecklistItem[]

  @@index([templateId])
  @@map("checklist_item_definitions")
}

// ─── Clinician Checklist Items ──────────────────────────

model ClinicianChecklistItem {
  id                      String              @id @default(uuid())
  organizationId          String              @map("organization_id")
  clinicianId             String              @map("clinician_id")
  itemDefinitionId        String              @map("item_definition_id")
  status                  ChecklistItemStatus @default(not_started)
  valueText               String?             @map("value_text")
  valueDate               DateTime?           @map("value_date")
  valueSelect             String?             @map("value_select")
  docStoragePath          String?             @map("doc_storage_path")
  docOriginalName         String?             @map("doc_original_name")
  docMimeType             String?             @map("doc_mime_type")
  expiresAt               DateTime?           @map("expires_at")
  docType                 String?             @map("doc_type")
  extractedExpirationDate DateTime?           @map("extracted_expiration_date")
  aiConfidence            Decimal?            @map("ai_confidence") @db.Decimal(5, 4)
  reviewedById            String?             @map("reviewed_by_id")
  reviewedAt              DateTime?           @map("reviewed_at")
  rejectionReason         String?             @map("rejection_reason")
  rejectionComment        String?             @map("rejection_comment")
  signerName              String?             @map("signer_name")
  signatureTimestamp      DateTime?           @map("signature_timestamp")
  signerIp                String?             @map("signer_ip")
  signatureHash           String?             @map("signature_hash")
  signedDocPath           String?             @map("signed_doc_path")
  createdAt               DateTime            @default(now()) @map("created_at")
  updatedAt               DateTime            @updatedAt @map("updated_at")

  organization   Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  clinician      Clinician               @relation(fields: [clinicianId], references: [id], onDelete: Cascade)
  itemDefinition ChecklistItemDefinition @relation(fields: [itemDefinitionId], references: [id])
  reviewedBy     User?                   @relation("ReviewedBy", fields: [reviewedById], references: [id])

  @@index([organizationId])
  @@index([clinicianId])
  @@index([status])
  @@index([expiresAt])
  @@map("clinician_checklist_items")
}

// ─── Template Documents ─────────────────────────────────

model TemplateDocument {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  templateId     String   @map("template_id")
  name           String
  storagePath    String   @map("storage_path")
  mimeType       String?  @map("mime_type")
  fileSizeBytes  Int?     @map("file_size_bytes")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organization Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  template     ChecklistTemplate       @relation(fields: [templateId], references: [id], onDelete: Cascade)
  linkedItems  ChecklistItemDefinition[]

  @@index([organizationId])
  @@index([templateId])
  @@map("template_documents")
}

// ─── Org Email Settings ─────────────────────────────────

model OrgEmailSettings {
  id                 String   @id @default(uuid())
  organizationId     String   @unique @map("organization_id")
  subject            String?
  introText          String?  @map("intro_text")
  requiredItemsIntro String?  @map("required_items_intro")
  signatureBlock     String?  @map("signature_block")
  legalDisclaimer    String?  @map("legal_disclaimer")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("org_email_settings")
}

// ─── Audit Logs ─────────────────────────────────────────

model AuditLog {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  actorUserId    String?  @map("actor_user_id")
  actorRole      Role?    @map("actor_role")
  clinicianId    String?  @map("clinician_id")
  entityType     String   @map("entity_type")
  entityId       String   @map("entity_id")
  action         String
  detailsJson    Json?    @map("details_json")
  createdAt      DateTime @default(now()) @map("created_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  actorUser    User?        @relation(fields: [actorUserId], references: [id])
  clinician    Clinician?   @relation(fields: [clinicianId], references: [id])

  @@index([organizationId])
  @@index([clinicianId])
  @@index([createdAt])
  @@map("audit_logs")
}

// ─── Internal Notes ─────────────────────────────────────

model InternalNote {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")
  clinicianId    String   @map("clinician_id")
  authorUserId   String   @map("author_user_id")
  content        String
  createdAt      DateTime @default(now()) @map("created_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  clinician    Clinician    @relation(fields: [clinicianId], references: [id], onDelete: Cascade)
  author       User         @relation(fields: [authorUserId], references: [id])

  @@index([organizationId, clinicianId])
  @@map("internal_notes")
}

// ─── Access Requests ───────────────────────────────────

enum AccessRequestStatus {
  pending
  reviewed
  approved
  rejected
}

model AccessRequest {
  id                      String              @id @default(uuid())
  agencyName              String              @map("agency_name")
  requesterName           String              @map("requester_name")
  workEmail               String              @map("work_email")
  phone                   String?
  state                   String?
  estimatedClinicianCount Int?                @map("estimated_clinician_count")
  emr                     String?
  status                  AccessRequestStatus @default(pending)
  reviewedAt              DateTime?           @map("reviewed_at")
  reviewNotes             String?             @map("review_notes")
  createdAt               DateTime            @default(now()) @map("created_at")
  updatedAt               DateTime            @updatedAt @map("updated_at")

  @@index([status])
  @@index([createdAt])
  @@map("access_requests")
}
